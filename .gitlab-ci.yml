# GitLab CI YML file dedicated for LC environment (Quartz)
#
# Spack must be available
# It would be better to install all Boost versions manually,
# as it causes errors often and could exceed the timelimit of the system.

stages:
  - install
  - build


variables:
  CUSTOM_CI_BUILDS_DIR: "/usr/workspace/$$USER/metall-ci-runner-builds-dir"
  GTEST_COLOR: "1"
  GIT_DEPTH: 0
#  CI_DEBUG_TRACE: "true" # Enable this when debugging this CI


install_boost:
  stage: install
  tags:
    - ruby
    - shell
  script:
    - hostname
    - srun -N1 -ppci spack install boost@1.86.0 boost@1.85.0 boost@1.84.0 boost@1.83.0 boost@1.82.0 boost@1.81.0 boost@1.80.0
    - spack clean


.build:
  stage: build
  tags:
    - quartz
    - shell
  script:
    - echo "=== build section ==="
    - module load gcc/${GCC_VERSION}
    - spack load --first boost@${BOOST_VERSION} arch=$(spack arch)
    - export METALL_TEST_DIR="/dev/shm/metall_test-${CI_CONCURRENT_ID}-${CI_PIPELINE_IID}"
    - srun -N1 -ppci bash ./scripts/CI/build_and_test.sh

build_gcc12.1.1_bst1.86.0:
  extends: .build
  variables:
    GCC_VERSION: "12.1.1"
    BOOST_VERSION: "1.86.0"

build_gcc12.1.1_bst1.85.0:
  extends: .build
  variables:
    GCC_VERSION: "12.1.1"
    BOOST_VERSION: "1.85.0"

build_gcc12.1.1_bst1.84.0:
  extends: .build
  variables:
    GCC_VERSION: "12.1.1"
    BOOST_VERSION: "1.84.0"

build_gcc12.1.1_bst1.83.0:
  extends: .build
  variables:
    GCC_VERSION: "12.1.1"
    BOOST_VERSION: "1.83.0"

build_gcc12.1.1_bst1.82.0:
  extends: .build
  variables:
    GCC_VERSION: "12.1.1"
    BOOST_VERSION: "1.82.0"

build_gcc12.1.1_bst1.81.0:
  extends: .build
  variables:
    GCC_VERSION: "12.1.1"
    BOOST_VERSION: "1.81.0"

build_gcc12.1.1_bst1.80.0:
  extends: .build
  variables:
    GCC_VERSION: "12.1.1"
    BOOST_VERSION: "1.80.0"
